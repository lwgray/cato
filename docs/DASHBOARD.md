# Cato - Marcus Visualization Dashboard

Multi-agent parallelization visualization dashboard for Marcus.

## Quick Start

### Using the Cato CLI (Recommended)

Start the dashboard:
```bash
./cato start
```

Stop the dashboard:
```bash
./cato stop
```

Restart the dashboard:
```bash
./cato restart
```

Check status:
```bash
./cato status
```

View logs:
```bash
./cato logs              # View all logs
./cato logs backend      # Backend only
./cato logs frontend     # Frontend only
```

The CLI automatically:
- Reads configuration from `config.json`
- Updates frontend `.env` with correct backend URL
- Starts/stops services cleanly
- Shows you exactly what's running

### Manual Setup

If you prefer to start services manually:

1. **Configure ports** (optional):
   Edit `config.json` to change default ports:
   ```json
   {
     "backend": {
       "host": "localhost",
       "port": 4301
     },
     "frontend": {
       "port": 5173
     }
   }
   ```

2. **Start Backend**:
   ```bash
   PYTHONPATH=. python backend/api.py
   ```

3. **Update Frontend Config**:
   Update `dashboard/.env`:
   ```
   VITE_API_URL=http://localhost:4301
   VITE_DATA_MODE=live
   ```

4. **Start Frontend**:
   ```bash
   cd dashboard
   npm run dev
   ```

## Configuration

### Centralized Configuration

All port configuration is managed in `config.json`:

```json
{
  "backend": {
    "host": "localhost",
    "port": 4301
  },
  "frontend": {
    "port": 5173
  }
}
```

**Important**: After changing ports in `config.json`, use `./start-dev.sh` to ensure everything is synchronized.

### CORS

The backend is configured to accept requests from **any localhost port** in development mode, so you don't need to worry about port conflicts.

## Architecture

### Backend (`backend/api.py`)
- FastAPI server providing unified snapshot API
- Reads configuration from `config.json`
- Allows CORS from all localhost origins
- Default port: 4301

### Frontend (`dashboard/`)
- React + TypeScript + Vite
- Reads backend URL from `.env` (auto-generated by `start-dev.sh`)
- Default port: 5173

### Data Aggregation (`src/core/aggregator.py`)
- Aggregates Marcus state from various sources
- Provides denormalized snapshots for frontend
- Handles task dependencies, agent assignments, messages, etc.

## Development

### View Logs

Backend logs:
```bash
tail -f /tmp/cato-backend.log
```

Frontend logs:
```bash
tail -f /tmp/cato-frontend.log
```

### API Endpoints

- `GET /` - API information
- `GET /health` - Health check
- `GET /api/projects` - List all projects
- `GET /api/snapshot` - Get unified visualization snapshot
  - Query params:
    - `project_id` (optional): Filter by project
    - `view` (optional): `subtasks`, `parents`, or `all`
    - `timeline_scale_exponent` (optional): Timeline scaling (default 0.4)
    - `use_cache` (optional): Use cached snapshot (default true)

### Data Modes

The dashboard supports two data modes:

1. **Live Mode** (default): Fetches real data from Marcus via backend API
2. **Mock Mode**: Uses generated mock data for testing

Toggle between modes using the button in the dashboard header.

## Troubleshooting

### Port Already in Use

If you get a "port already in use" error:

```bash
# Stop all services
./stop-dev.sh

# Check what's using the port
lsof -i :4301  # or your configured port

# Kill the process if needed
kill -9 <PID>

# Restart
./start-dev.sh
```

### Frontend Can't Connect to Backend

1. Check backend is running:
   ```bash
   curl http://localhost:4301/health
   ```

2. Check `.env` file has correct URL:
   ```bash
   cat dashboard/.env
   ```

3. Restart with automated script:
   ```bash
   ./stop-dev.sh
   ./start-dev.sh
   ```

### CORS Errors

If you see CORS errors, ensure:
- Backend is running on localhost (not 127.0.0.1)
- Frontend is accessing via localhost (not 127.0.0.1)
- Or use `./start-dev.sh` which handles this automatically

## Project Structure

```
viz/
├── config.json              # Centralized port configuration
├── start-dev.sh            # Automated startup script
├── stop-dev.sh             # Stop all services
├── backend/
│   └── api.py              # FastAPI backend
├── dashboard/              # React frontend
│   ├── src/
│   │   ├── components/     # React components
│   │   ├── services/       # API services
│   │   └── store/          # Zustand state management
│   └── .env                # Auto-generated by start-dev.sh
└── src/core/
    └── aggregator.py       # Data aggregation logic
```

## Features

- **Network Graph**: Task dependency visualization
- **Agent Swim Lanes**: Timeline view of agent task execution
- **Conversations**: Agent-to-agent message flow
- **Metrics Panel**: System-wide statistics
- **Timeline Playback**: Scrub through execution history
- **Project Filtering**: View specific projects or all projects
- **Real-time Updates**: Auto-refresh in live mode
